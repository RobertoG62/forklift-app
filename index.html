<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forklift Master - Final Fix</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Rubik', sans-serif; background: #f8fafc; color: #1e293b; min-height: 100vh; }
        .forklift-icon { fill: currentColor; display: inline-block; width: 1.4em; height: 1.4em; vertical-align: middle; }
        .tab-btn { padding: 12px 24px; font-weight: 700; color: #64748b; background: transparent; border: none; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s ease; white-space: nowrap; }
        .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; background-color: white; border-radius: 8px 8px 0 0; }
        .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        tr.row-status-urgent { background-color: #fef2f2 !important; border-right: 4px solid #ef4444 !important; }
        tr.row-status-warning { background-color: #fffbeb !important; border-right: 4px solid #facc15 !important; }
        tr.row-status-ok { background-color: #ffffff !important; border-right: 4px solid #10b981 !important; }

        .status-badge { display: flex; flex-direction: column; align-items: flex-start; padding: 6px 10px; border-radius: 8px; width: 100%; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .badge-danger { background-color: #ef4444; color: white; border: 1px solid #dc2626; }
        .badge-warning { background-color: #fef08a; color: #854d0e; border: 1px solid #facc15; }
        .badge-success { background-color: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .badge-error { background-color: #f3f4f6; color: #9ca3af; border: 1px solid #e5e7eb; }
        .cal-btn { font-size: 0.7rem; margin-top: 4px; padding: 2px 6px; border-radius: 4px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; }
        .days-tag { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
    </style>
</head>
<body class="pb-12">

    <header class="bg-slate-900 text-white shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 h-20 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg p-2">
                    <svg class="forklift-icon w-full h-full" viewBox="0 0 24 24"><path d="M4 22V2h2v9h4l2-5h5l2 5h1v-2h2v2h1v2h-1v5h-1v2h-1v-2H13c-1.1 0-2 .9-2 2H9v-2H6v2H4zm5-7h8v-3h-2.5l-1-2.5h-3l-1 2.5H9v3z"/></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-black tracking-tight">FORKLIFT <span class="text-blue-400">MASTER</span></h1>
                    <p class="text-xs text-slate-400">GitHub Edition (Fixed)</p>
                </div>
            </div>
            <div class="hidden md:flex items-center gap-2 bg-slate-800 px-3 py-1.5 rounded-lg border border-slate-700">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-xs font-bold text-slate-300">转拽</span>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="flex gap-2 border-b border-slate-300/50 mb-6 overflow-x-auto">
            <button class="tab-btn active" onclick="switchTab('dashboard')"><i class="fas fa-chart-pie"></i> 砖专</button>
            <button class="tab-btn" onclick="switchTab('fleet')"><i class="fas fa-list"></i> 转 转</button>
            <button class="tab-btn" onclick="switchTab('settings')"><i class="fas fa-cog"></i> 专转</button>
        </div>

        <div id="tab-dashboard" class="tab-content active">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-blue-500"><div><p class="text-xs font-bold text-slate-500 uppercase">住" 爪</p><h3 class="text-3xl font-black text-slate-800" id="kpiTotal">0</h3></div></div>
                <div class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-red-500"><p class="text-xs font-bold text-slate-500 uppercase">驻 转拽祝</p><h3 class="text-3xl font-black text-red-600" id="kpiUrgent">0</h3></div>
                <div class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-yellow-400"><p class="text-xs font-bold text-slate-500 uppercase">转拽专 (30 )</p><h3 class="text-3xl font-black text-yellow-600" id="kpiWarning">0</h3></div>
                <div class="bg-white p-5 rounded-xl shadow-sm border-t-4 border-green-500"><p class="text-xs font-bold text-slate-500 uppercase">转拽</p><h3 class="text-3xl font-black text-green-600" id="kpiOk">0</h3></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><h3 class="font-bold text-slate-700 mb-4">住住 </h3><div id="statusChart" class="h-64"></div></div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><h3 class="font-bold text-slate-700 mb-4">爪驻 驻拽注转 转拽祝</h3><div id="forecastChart" class="h-64"></div></div>
            </div>
        </div>

        <div id="tab-fleet" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                <div class="p-4 bg-slate-50 border-b border-slate-200 flex flex-wrap justify-between items-center gap-4">
                    <h2 class="text-lg font-bold text-slate-800">专砖转 爪</h2>
                    <div class="flex flex-wrap gap-2 items-center">
                        <input type="text" id="searchBox" onkeyup="renderTable()" placeholder="驻砖 驻砖..." class="px-3 py-2 border rounded-lg text-sm w-40 focus:ring-2 focus:ring-blue-500 outline-none">
                        <select id="statusFilter" onchange="renderTable()" class="px-3 py-2 border rounded-lg text-sm font-medium focus:ring-2 focus:ring-blue-500 outline-none bg-white cursor-pointer">
                            <option value="all"></option>
                            <option value="urgent"> 驻 转拽祝</option>
                            <option value="warning"> 转拽专</option>
                            <option value="ok"> 转拽</option>
                        </select>
                        <label class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-bold cursor-pointer flex items-center gap-2 shadow-sm transition">
                            <i class="fas fa-file-csv"></i>  CSV
                            <input type="file" id="csvImportInput" class="hidden" accept=".csv" onchange="importCSV(this)">
                        </label>
                        <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-sm transition"><i class="fas fa-plus"></i> 砖</button>
                    </div>
                </div>
                <div class="overflow-x-auto min-h-[300px]">
                    <table class="w-full text-right border-collapse">
                        <thead>
                            <tr class="bg-slate-100 uppercase border-b border-slate-200 text-xs text-slate-500">
                                <th class="p-4">住驻专 </th><th class="p-4">住驻专 专砖</th><th class="p-4">转拽祝 </th><th class="p-4">转拽祝 转住拽专</th><th class="p-4">转拽祝 专砖</th><th class="p-4 text-center">驻注转</th>
                            </tr>
                        </thead>
                        <tbody id="fleetTableBody"></tbody>
                    </table>
                    <div id="tableEmptyState" class="hidden text-center py-12"><p class="text-slate-400 text-lg"> 转. 注 CSV.</p></div>
                </div>
                <div class="p-3 bg-slate-50 border-t text-xs text-slate-500 font-bold" id="rowsCount"></div>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            <div class="max-w-xl mx-auto space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-lg mb-4"> 转</h3>
                    <div class="bg-blue-50 p-4 rounded-lg text-sm text-blue-800 mb-6 border border-blue-200">
                        <i class="fas fa-info-circle"></i> 转 砖专 驻驻 (localStorage).
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadJSON()" class="flex-1 bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-slate-700"><i class="fas fa-download"></i> 专 </button>
                        <button onclick="document.getElementById('jsonInput').click()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700"><i class="fas fa-upload"></i> 注 </button>
                        <input type="file" id="jsonInput" class="hidden" accept=".json" onchange="loadJSON(this)">
                        <button onclick="clearData()" class="flex-1 bg-red-100 text-red-600 py-3 rounded-lg font-bold hover:bg-red-200"><i class="fas fa-trash"></i> 驻住 </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-[fadeIn_0.2s]">
            <div class="bg-slate-800 p-4 flex justify-between items-center text-white"><h3 class="font-bold text-lg">注专</h3><button onclick="closeModal()" class="text-slate-400 hover:text-white">X</button></div>
            <form id="editForm" class="p-6 space-y-4">
                <input type="hidden" id="editId">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-500">住驻专 </label><input type="text" id="inpNum" class="w-full border p-2 rounded" required></div>
                    <div><label class="block text-xs font-bold text-blue-600">住驻专 专砖</label><input type="text" id="inpLicense" class="w-full border p-2 rounded"></div>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <div><label class="block text-xs font-bold text-slate-500"></label><input type="date" id="inpIns" class="w-full border p-2 rounded"></div>
                    <div><label class="block text-xs font-bold text-slate-500">转住拽专</label><input type="date" id="inpSafety" class="w-full border p-2 rounded"></div>
                    <div><label class="block text-xs font-bold text-slate-500">专砖</label><input type="date" id="inpLic" class="w-full border p-2 rounded"></div>
                </div>
                <div class="pt-4 flex justify-end gap-2">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-slate-600 font-bold hover:bg-slate-100 rounded-lg"></button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">砖专</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let forklifts = [];
        const STORAGE_KEY = 'forklift_gh_v3_fixed';

        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if(saved) forklifts = JSON.parse(saved);
            renderAll();
        });

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(forklifts));
            renderAll();
        }

        // --- IMPORT CSV LOGIC (THE FIX) ---
        // 驻拽爪  砖转 转 拽转    注 
        function findColumnValue(row, exactMatch, ...fallbacks) {
            const keys = Object.keys(row);
            
            // 1. 住 爪 转 拽转 (注驻转 注)
            // :  驻砖 "住驻专 专砖",  爪 ,  转 注 "转专 专砖"
            let foundKey = keys.find(k => k.trim() === exactMatch);
            
            // 2.   爪, 住 转 驻转 住驻转 ( 专转)
            if (!foundKey && fallbacks.length > 0) {
                foundKey = keys.find(k => fallbacks.some(word => k.includes(word)));
            }
            
            return foundKey ? row[foundKey] : '';
        }

        function importCSV(input) {
            const file = input.files[0];
            if(!file) return;
            
            Papa.parse(file, {
                header: true, 
                skipEmptyLines: true, 
                encoding: "UTF-8",
                complete: function(results) {
                    if (results.data.length === 0) return alert("拽抓 专拽");
                    
                    const imported = results.data.map((row, idx) => {
                        return {
                            id: Date.now() + idx,
                            // 驻 拽 驻 拽抓 砖
                            num: findColumnValue(row, '住驻专 ', 'num'),
                            
                            //  转拽: 驻砖 驻专砖 "住驻专 专砖"
                            license: findColumnValue(row, '住驻专 专砖', 'license'),
                            
                            // 转专: 驻砖 "转拽祝 " '
                            ins: findColumnValue(row, '转专 转拽祝 ', '', 'ins'),
                            safety: findColumnValue(row, '转专 转拽祝 转住拽专', '转住拽专', 'safety'),
                            
                            //  转拽 拽专 转专 专砖: 驻砖 "转拽祝 专砖"  住转 "专砖"
                            lic: findColumnValue(row, '转专 转拽祝 专砖', '转拽祝 专砖', '住') 
                        };
                    }).filter(x => x.num);

                    if(confirm(`爪 ${imported.length} 砖专转. ?`)) {
                        forklifts = [...forklifts, ...imported];
                        saveData();
                        alert(" 砖 爪!");
                    }
                }
            });
            input.value = '';
        }

        // --- DATE PARSING FIX ---
        function parseDate(s) { 
            if(!s) return null; 
            const str = s.toString().trim();
            if(str.length < 5) return null;
            let parts = str.split(/[-/.]/);
            if(parts.length !== 3) return null;
            let y, m, d;
            // YYYY-MM-DD
            if (parts[0].length === 4) { y = parseInt(parts[0]); m = parseInt(parts[1]); d = parseInt(parts[2]); } 
            // DD/MM/YYYY
            else { d = parseInt(parts[0]); m = parseInt(parts[1]); y = parseInt(parts[2]); }
            if(isNaN(y) || isNaN(m) || isNaN(d)) return null;
            if(y < 100) y += 2000;
            return new Date(y, m - 1, d);
        }

        function calculateStatus(f) { 
            let min = 999; 
            [f.ins, f.safety, f.lic].forEach(s => {
                const d = parseDate(s); 
                if(d) {
                    const diff = Math.ceil((d - new Date().setHours(0,0,0,0)) / 86400000);
                    if (diff < min) min = diff;
                }
            }); 
            if(min > 3650) return {status: 'ok'}; 
            return {status: min <= 0 ? 'urgent' : (min <= 30 ? 'warning' : 'ok')}; 
        }
        
        // --- RENDER ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
            event.target.closest('button').classList.add('active');
            if(id==='dashboard') renderAll();
        }

        function renderAll() { renderStats(); renderTable(); renderCharts(); }

        function renderTable() {
            const tbody = document.getElementById('fleetTableBody');
            const term = document.getElementById('searchBox').value.toLowerCase();
            const filter = document.getElementById('statusFilter').value;
            tbody.innerHTML = '';
            
            const filtered = forklifts.filter(f => {
                const match = (f.num + f.license).toLowerCase().includes(term);
                const status = calculateStatus(f).status;
                return match && (filter === 'all' || status === filter);
            });

            document.getElementById('rowsCount').innerText = `住" ${filtered.length}`;
            document.getElementById('tableEmptyState').className = filtered.length === 0 ? 'text-center py-12' : 'hidden';

            filtered.forEach(f => {
                const s = calculateStatus(f);
                const tr = document.createElement('tr');
                tr.className = `border-b border-slate-200 hover:bg-slate-50 row-status-${s.status}`;
                tr.innerHTML = `
                    <td class="p-4 font-bold text-slate-800">${f.num}</td>
                    <td class="p-4 font-mono text-blue-700">${f.license || '-'}</td>
                    ${renderCell(f.ins)} ${renderCell(f.safety)} ${renderCell(f.lic)}
                    <td class="p-4 text-center">
                        <button onclick="editItem(${f.id})" class="text-blue-600 p-2"><i class="fas fa-pen"></i></button>
                        <button onclick="deleteItem(${f.id})" class="text-red-600 p-2"><i class="fas fa-trash"></i></button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        function renderCell(dateStr) {
            const d = parseDate(dateStr);
            if (!d) return `<td class="p-3"><div class="status-badge badge-error">---</div></td>`;
            const days = Math.ceil((d - new Date().setHours(0,0,0,0)) / 86400000);
            let cls = days <= 0 ? "badge-danger" : (days <= 30 ? "badge-warning" : "badge-success");
            let txt = days > 0 ? `(注 ${days})` : "驻 转拽祝";
            const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), day = String(d.getDate()).padStart(2,'0');
            const gDate = `${y}${m}${day}`;
            const calUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent('转专转 ')}&dates=${gDate}/${gDate}`;
            return `<td class="p-3"><div class="status-badge ${cls}"><div class="flex justify-between w-full"><span class="font-bold text-sm">${d.toLocaleDateString('en-GB')}</span><a href="${calUrl}" target="_blank" class="cal-btn"><i class="far fa-calendar-plus"></i></a></div><span class="days-tag">${txt}</span></div></td>`;
        }

        function renderStats() {
            const c = { urgent: 0, warning: 0, ok: 0 };
            forklifts.forEach(f => c[calculateStatus(f).status]++);
            document.getElementById('kpiTotal').innerText = forklifts.length;
            document.getElementById('kpiUrgent').innerText = c.urgent;
            document.getElementById('kpiWarning').innerText = c.warning;
            document.getElementById('kpiOk').innerText = c.ok;
        }

        function renderCharts() {
            if(forklifts.length === 0) return;
            const c = { urgent: 0, warning: 0, ok: 0 };
            forklifts.forEach(f => c[calculateStatus(f).status]++);
            Plotly.newPlot('statusChart', [{ values: [c.urgent, c.warning, c.ok], labels: ['驻 转拽祝', '转拽专', '转拽'], type: 'pie', marker: { colors: ['#ef4444', '#facc15', '#10b981'] }, hole: 0.5 }], { height: 250, margin: {t:0,b:0,l:0,r:0} });
            const months = {};
            forklifts.forEach(f => [f.ins, f.safety, f.lic].forEach(ds => {
                const d = parseDate(ds); if(d && d > new Date()) months[`${d.getMonth()+1}/${d.getFullYear()}`] = (months[`${d.getMonth()+1}/${d.getFullYear()}`]||0)+1;
            }));
            const x = Object.keys(months).sort((a,b) => new Date(a.split('/')[1],a.split('/')[0]) - new Date(b.split('/')[1],b.split('/')[0]));
            Plotly.newPlot('forecastChart', [{ x: x, y: x.map(k=>months[k]), type: 'bar', marker: {color: '#3b82f6'} }], { height: 250, margin: {t:20,b:30,l:30,r:10} });
        }

        // Helpers
        function toInputDate(s) { const d=parseDate(s); return d?d.toISOString().split('T')[0]:''; }
        function fromInputDate(s) { if(!s)return ''; const [y,m,d]=s.split('-'); return `${d}/${m}/${y}`; }
        function downloadJSON() { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(forklifts)],{type:'application/json'})); a.download='backup.json'; a.click(); }
        function loadJSON(input) { const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload = (e) => { try { forklifts = JSON.parse(e.target.result); saveData(); alert("注!"); } catch(err) { alert("砖 拽抓"); } }; r.readAsText(f); input.value = ''; }
        function clearData() { if(confirm('拽 ?')) { forklifts = []; saveData(); } }

        window.openModal = () => { document.getElementById('editModal').classList.remove('hidden'); document.getElementById('editForm').reset(); document.getElementById('editId').value = ''; };
        window.closeModal = () => document.getElementById('editModal').classList.add('hidden');
        window.editItem = (id) => { const f = forklifts.find(x=>x.id===id); document.getElementById('editId').value=f.id; document.getElementById('inpNum').value=f.num; document.getElementById('inpLicense').value=f.license; document.getElementById('inpIns').value=toInputDate(f.ins); document.getElementById('inpSafety').value=toInputDate(f.safety); document.getElementById('inpLic').value=toInputDate(f.lic); document.getElementById('editModal').classList.remove('hidden'); };
        window.deleteItem = (id) => { if(confirm('拽?')) { forklifts=forklifts.filter(x=>x.id!==id); saveData(); } };
        document.getElementById('editForm').onsubmit = (e) => { e.preventDefault(); const id = document.getElementById('editId').value; const item = { id: id?+id:Date.now(), num: document.getElementById('inpNum').value, license: document.getElementById('inpLicense').value, ins: fromInputDate(document.getElementById('inpIns').value), safety: fromInputDate(document.getElementById('inpSafety').value), lic: fromInputDate(document.getElementById('inpLic').value) }; if(id) { forklifts[forklifts.findIndex(x=>x.id==id)] = item; } else { forklifts.push(item); } saveData(); closeModal(); };
    </script>
</body>
</html>
